---
import Layout from '../layouts/Layout.astro';
import TeamCard from '../components/TeamCard.astro';
import { getCollection } from 'astro:content';

const allMembers = await getCollection('team');

// Define groups based on domestic hierarchy + international standard
const groups = [
  {
    id: 'pi',
    titleKey: 'team.pi',
    roles: ['Principal Investigator']
  },
  {
    id: 'faculty',
    titleKey: 'team.faculty',
    roles: ['Professor', 'Associate Professor', 'Assistant Professor']
  },
  {
    id: 'postdoc',
    titleKey: 'team.youth_researcher',
    roles: ['Postdoc']
  },
  {
    id: 'staff',
    titleKey: 'team.support',
    roles: ['Research Assistant']
  },
  {
    id: 'phd',
    titleKey: 'team.phd',
    roles: ['PhD Student']
  },
  {
    id: 'master',
    titleKey: 'team.master',
    roles: ['Master Student']
  },
  {
    id: 'undergrad',
    titleKey: 'team.undergrad',
    roles: ['Undergraduate']
  },
  {
    id: 'alumni',
    titleKey: 'team.alumni',
    roles: ['Alumni']
  }
];

const getRolePriority = (role: string) => {
  const priorities: Record<string, number> = {
    'Principal Investigator': 0,
    'Professor': 1,
    'Associate Professor': 2,
    'Assistant Professor': 3,
    'Postdoc': 4,
    'Research Assistant': 5,
    'PhD Student': 6,
    'Master Student': 7,
    'Undergraduate': 8,
    'Alumni': 9
  };
  return priorities[role] ?? 99;
};

// Group members
const groupedMembers = groups.reduce((acc, group) => {
  const members = allMembers
    .filter(m => group.roles.includes(m.data.role))
    .sort((a, b) => {
      // Sort by Role Priority first (e.g. Prof before Assoc Prof)
      const roleDiff = getRolePriority(a.data.role) - getRolePriority(b.data.role);
      if (roleDiff !== 0) return roleDiff;
      // Then by weight
      return (a.data.weight || 100) - (b.data.weight || 100);
    });
  
  if (members.length > 0) {
    acc.push({
      ...group,
      members
    });
  }
  return acc;
}, [] as Array<{ id: string, titleKey: string, roles: string[], members: typeof allMembers }>);

---

<Layout title="Team">
  <div class="max-w-7xl mx-auto px-4 py-12 sm:py-20">
    <div class="max-w-3xl mx-auto text-center mb-16">
      <h1 class="text-4xl font-bold text-gray-900 mb-4" data-i18n-key="team.title">Our Team</h1>
      <p class="text-lg text-gray-600" data-i18n-key="team.subtitle">
        Meet the researchers and students behind our innovations.
      </p>
    </div>

    <div class="space-y-20">
      {groupedMembers.map(group => (
        <section>
          <h2 class="text-2xl font-bold text-gray-900 mb-8 pl-4 border-l-4 border-blue-600" data-i18n-key={group.titleKey}>
            {/* Fallback text if JS doesn't replace it immediately, though i18n script should handle it */}
            {group.id === 'pi' ? 'Principal Investigator' :
             group.id === 'faculty' ? 'Faculty' :
             group.id === 'postdoc' ? 'Postdoctoral Researchers' :
             group.id === 'staff' ? 'Research Support' :
             group.id === 'phd' ? 'PhD Students' :
             group.id === 'master' ? 'Master Students' :
             group.id === 'undergrad' ? 'Undergraduate Students' :
             group.id === 'alumni' ? 'Alumni' : ''}
          </h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-8 gap-y-12">
            {group.members.map(member => (
              <TeamCard member={member} />
            ))}
          </div>
        </section>
      ))}

      {allMembers.length === 0 && (
        <p class="text-gray-500 text-center py-12" data-i18n-key="team.noMembers">No team members found. Add markdown files to src/content/team/</p>
      )}
    </div>
  </div>
</Layout>