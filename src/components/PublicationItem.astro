---
import { FileText, Github, Play, MonitorPlay, Video, ExternalLink, Globe, Sparkles } from 'lucide-react';
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';

interface Props {
  entry: CollectionEntry<'publications'>;
}

const { entry } = Astro.props;
const { title, authors, year, venue, links, award, cover, badges } = entry.data;

const iconMap: Record<string, any> = {
  pdf: FileText,
  code: Github,
  demo: Play,
  slides: MonitorPlay,
  video: Video,
  website: Globe,
};

const badgeStyles: Record<string, string> = {
  gold: "bg-gradient-to-r from-amber-50 to-yellow-50 text-amber-700 border-amber-200 shadow-sm",
  blue: "bg-blue-50 text-blue-700 border-blue-100",
  red: "bg-rose-50 text-rose-700 border-rose-100",
  green: "bg-emerald-50 text-emerald-700 border-emerald-100",
  default: "bg-gray-50 text-gray-700 border-gray-200"
};

// Helper to format link label (e.g., "pdf" -> "PDF")
const formatLabel = (key: string) => {
  if (key === 'pdf') return 'PDF';
  if (key === 'github') return 'Code';
  if (key === 'website') return 'Project';
  return key.charAt(0).toUpperCase() + key.slice(1);
};
---

<div class="flex flex-col sm:flex-row gap-6 py-8 border-b border-gray-100 last:border-0 group">
  {cover && (
    <div class="shrink-0 w-full sm:w-48 h-32 sm:h-28 rounded-lg overflow-hidden border border-gray-100 bg-gray-50">
      <Image src={cover} alt={title} class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" quality={80} format="webp" width={300} />
    </div>
  )}
  
  <div class="flex-grow space-y-2">
    <!-- Title -->
    <h3 class="text-lg font-semibold text-gray-900 leading-tight group-hover:text-blue-600 transition-colors">
      {links?.website ? <a href={links.website} target="_blank">{title}</a> : (links?.pdf ? <a href={links.pdf} target="_blank">{title}</a> : title)}
    </h3>
    
    <!-- Authors -->
    <div class="text-gray-600 text-sm leading-relaxed">
      {authors.join(', ')}
    </div>
    
    <!-- Venue & Year & Badges -->
    <div class="flex items-center flex-wrap gap-2 text-sm text-gray-500">
      <span class="font-medium text-gray-800">{venue}</span>
      <span>Â·</span>
      <span>{year}</span>
      
      {/* Legacy award support (fallback) */}
      {award && !badges && (
        <span class="px-2 py-0.5 rounded-full bg-gradient-to-r from-amber-50 to-yellow-50 text-amber-700 text-xs font-medium border border-amber-200 flex items-center gap-1 shadow-sm">
          <Sparkles class="w-3 h-3" /> {award}
        </span>
      )}

      {/* New Badges System */}
      {badges && badges.map(badge => (
        <span class={`px-2 py-0.5 rounded-full text-xs font-medium border flex items-center gap-1 ${badgeStyles[badge.type] || badgeStyles.default}`}>
           {badge.type === 'gold' && <Sparkles class="w-3 h-3" />}
           {badge.text}
        </span>
      ))}
    </div>
    
    <!-- Links -->
    {links && Object.keys(links).length > 0 && (
      <div class="flex flex-wrap gap-3 pt-1">
        {Object.entries(links).map(([key, url]) => {
          if (!url || url === '#') return null;
          const Icon = iconMap[key] || ExternalLink;
          return (
            <a 
              href={url}
              target="_blank"
              class="inline-flex items-center gap-1.5 px-3 py-1 text-xs font-medium text-gray-600 border border-gray-200 rounded-md hover:text-blue-600 hover:border-blue-200 hover:bg-blue-50 transition-all"
            >
              <Icon className="w-3.5 h-3.5" />
              {formatLabel(key)}
            </a>
          );
        })}
      </div>
    )}
  </div>
</div>
